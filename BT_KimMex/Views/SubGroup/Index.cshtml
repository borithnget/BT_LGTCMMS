
@{
    ViewBag.Title = "Sub Group List";

}

<div class="panel panel-default">
    <div class="panel-heading">@ViewBag.Title</div>
    <div class="panel-body">
        <div class="table-responsive">
            <table id="table1" class="table table-bordered">
                <thead>
                    <tr>
                        <th>N.O</th>
                        <th>Group</th>
                        <th>Sub Group Code</th>
                        <th>Sub Group Name</th>       
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create/Edit modal popup-->
<div class="modal fade" id="myModal" tabindex="=-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header alert alert-success">
                <h4 class="modal-title" id="myModalLabel">Create / Edit Sub Group</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" id="md_sub_group_id"/>
                <div class="form-group row">
                    <label class="col-md-4 control-label">Group <strong class="text-danger">*</strong>:</label>
                    <div class="col-md-8">
                        <select class="form-control" id="md_group"></select>
                    </div>
                </div>
                <div class="form-group row" id="panel_subgroup_code">
                    <label class="col-md-4 control-label">Sub Group Code<strong class="text-danger">*</strong>:</label>
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="md_sub_group_code" />
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-md-4 control-label">Sub Group Name<strong class="text-danger">*</strong>:</label>
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="md_sub_group_name" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success " id="btn_md_submit">Submit</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script type="text/javascript">
        $(function (e) {

            initialSubGroupDataTable();
            initialGroupControl('');

            $('#btn_create_new').click(function () {
                //$('#panel_subgroup_code').hide();
                initialGroupControl('');
                $('#md_sub_group_id').val('');
                $('#md_sub_group_code').val('');
                $('#md_sub_group_name').val('');
                $('#myModal').modal('show');
            });

            $('#btn_md_submit').click(function () {
                $('#btn_md_submit').attr("disabled", true);
                var model = {
                    sub_group_id: $('#md_sub_group_id').val(),
                    class_id: $('#md_group').val(),
                    sub_group_code: $('#md_sub_group_code').val(),
                    sub_group_name: $('#md_sub_group_name').val()
                };

                $.ajax({
                    url: "/SubGroup/CreateUpdateAJAX",
                        data: {
                            'model': model,
                        },
                        type: 'POST',
                    success: function (response) {
                        $('#btn_md_submit').attr("disabled", false);
                        
                        if (response.response.isSuccess)
                        {
                            alert('Your data has been saved.');
                            
                            //initialSubGroupDataTable();
                            window.location.reload();
                            $('#myModal').modal('hide');
                        }
                        else
                            $.notify(response.response.message, { className: 'error' });
                        },
                        error: function (err) {
                            $.notify('Your data has been error while saving!', { className: 'error' });
                        }
                    });

            });

            $('#table1 tbody').on('click', 'td a.btn_edit', function () {

                $('#panel_subgroup_code').show();
                var sub_group_id = $(this).attr('data-id');
                var sub_group_name = $(this).attr('data-name');
                var sub_group_code = $(this).attr('data-code');
                var group_id = $(this).attr('data-groupid');
                initialGroupControl(group_id)
                $('#md_sub_group_id').val(sub_group_id);
                $('#md_sub_group_code').val(sub_group_code);
                $('#md_sub_group_name').val(sub_group_name);


                $('#myModal').modal('show');
            });

            $('#table1 tbody').on('click', 'td a.btn_delete', function () {

                var sub_group_id = $(this).attr('data-id');
                const response = confirm("Do want to delete this item?");

                if (response) {
                    $.ajax({
                        url: "/SubGroup/Delete",
                        data: {
                            'id': sub_group_id,
                        },
                        type: 'POST',
                        success: function (response) {
                            $('#btn_md_submit').attr("disabled", false);

                            if (response.response.isSuccess) {
                                alert('Your data has been saved.');

                                //initialSubGroupDataTable();
                                window.location.reload();

                            }
                            else
                                $.notify(response.response.message, { className: 'error' });
                        },
                        error: function (err) {
                            $.notify('Your data has been error while saving!', { className: 'error' });
                        }
                    });
                }
    
            });

        });

        function initialGroupControl(groupId) {
            $('#md_group').empty().append("<option value=''>Select Group</option>");
                $.ajax({
                    url: "/Class/GetClassListJson",
                        type: 'GET',
                    success: function (response) {
                        console.log(response);
                        $.each(response.data, function (index, item) {
                            var item_code = item.class_code == null ? "" : item.class_code + "-";
                            $('#md_group').append("<option value='" + item.class_id + "'>" + item_code + item.class_name + "</option>");
                        });
                        if (groupId.length > 0)
                            $('#md_group').val(groupId);
                    },
                        error: function (err) {

                            $.notify('Your data has been error while deleting!', { className: 'error' });
                        }
                    });
        }

        function initialSubGroupDataTable() {
            var t = $('#table1').DataTable({
                "bDestroy": true,
                "ajax": {
                    "url": "@Url.Action("GetSubGroupDataTable", "SubGroup")",
                    "type": "GET",
                    "dataType": "json"
                },
                    "columns": [
                        { "data": "sub_group_id" },
                        {
                            "render": function (data, type, full, meta) {
                                return full.group.class_name;
                            }
                        },
                        { "data": "sub_group_code" },
                        {"data":"sub_group_name"},
                        
                        {
                            "render": function (data, type, full, meta) {
                                return '<a href="javascript:void(0)" data-id="' + full.sub_group_id + '" data-name="' + full.sub_group_name +'" data-code="' + full.sub_group_code + '" data-groupid="' + full.group.class_id + '" class="w3-button w3-tiny w3-green btn_edit"><i class="fa fa-edit"></i></a> ' +
                                    '<a href="javascript:void(0)" data-id="' + full.sub_group_id + '" class="w3-button w3-tiny w3-green btn_delete"><i class="fa fa-trash"></i></a> ';
                            }
                        },
                    ],
                "order": [[1, "asc"],[2,"asc"]],
                    "columnDefs": [
                            //{
                            //    "targets": [9],
                            //    "visible": false,
                            //},
                        {
                        "targets": 4,
                        "className": "text-center",
                    },
                            
                        ]
            });
            t.on('order.dt search.dt', function () {
                t.column(0, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
                    cell.innerHTML = i + 1;
                });
            }).draw();
            $('select[name="table1_length"]').addClass('datatable-control');
            $('input[aria-controls="classtable"]').addClass('datatable-control');
            $('#table1_filter').append('<a href="javascript:void(0)" class="w3-button w3-tiny w3-green  pull-left" id="btn_create_new" style="margin-right:10px !important;">Add New</a>');
        }
    </script>
}