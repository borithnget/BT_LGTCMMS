@model BT_KimMex.Models.ReturnMainStockViewModel
@using BT_KimMex.Class
@using Microsoft.AspNet.Identity;
@{
    ViewBag.Title = "ApproveFeedback";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style type="text/css">
    #returnTable tr td{
        vertical-align:middle !important;
    }
</style>

<h3 class="title">Approve/Feedback Return to Workshop</h3>

<div class="form-horizontal">
    @Html.HiddenFor(model=>model.return_main_stock_id)
    <div class="row">
        <div class="form-group">
            @Html.Label("Reqeusted Date:", new { @class = "control-label col-md-2" })
            <label class="col-md-10">@CommonClass.ToLocalTime(Convert.ToDateTime(Model.create_date)).ToString("dd/MM/yyyy")</label>
        </div>
        <div class="form-group">
            <label class="control-label col-md-2">Return Number:</label>
            <label class="col-md-10">@Model.return_main_stock_no</label>
        </div>
        @*<div class="form-group">
            <label class="control-label col-md-2">Return Type:</label>
            @Html.DisplayFor(model => model.return_type, new { @class = "col-md-10" })
        </div>
        <div class="form-group">
            <label class="control-label col-md-2">Transfer Ref.:</label>
            @Html.DisplayFor(model => model.return_ref_number, new { @class = "col-md-10" })
        </div>*@
        <div class="form-group">
            <label class="control-label col-md-2">Project Name:</label>
            <div class="col-md-10">
                <label id="project">@Model.project_fullname</label>
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-md-2">From Warehouse:</label>
            <div class="col-md-10">
                <label id="warehouse">@Model.warehouse_name</label>
            </div>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-bordered" id="returnTable">
            <thead>
                <tr>
                    <th>No.</th>
                    <th>Item Code</th>
                    <th>Item Name</th>
                    @*<th>Transfered QTY</th>
        <th>Remain QTY</th>*@
                    <th>Return QTY</th>
                    <th><label><input type="radio" class="approval" name="app_header" value="approved"> Approve</label></th>
                    <th><label><input type="radio" class="approval" name="app_header" value="feedbacked"> Feedback</label></th>
                    <th>Comment</th>
                </tr>
            </thead>
            <tbody>
                @{
                    int count = 1;
                    int cc = 1;
                    foreach (var item in Model.inventoryDetails)
                    {

                        if (string.Compare(item.item_status, "completed") == 0)
                        {
                            <tr>
                                <td>@count</td>
                                <td>@item.itemCode</td>
                                <td>@item.itemName</td>
                                @*<td>@string.Format("{0:G29}", Double.Parse(stitem.quantity.ToString())) @stitem.unitName</td>
                                <td>@string.Format("{0:G29}", Double.Parse(stitem.remain_quantity.ToString())) @stitem.unitName</td>*@
                                <td class="text-center">@string.Format("{0:G29}", Double.Parse(item.out_quantity.ToString())) @item.unitName</td>
                                <td></td>
                                <td></td>
                                <td>@item.remark</td>
                            </tr>
                        }
                        else
                        {
                            string name = "item" + cc;
                            <tr>
                                <td>@count</td>
                                <td>
                                    @*@if (User.IsInRole("Admin") || issm != null || User.IsInRole("QA/QC Officer"))
                                        {*@

                                    @* } *@
                                    @{
                                        name = "item" + cc;
                                        <input type="hidden" value="@item.inventory_id" class="transfer_detail" />
                                        cc++;
                                    }

                                    @item.itemCode
                                </td>
                                <td>@item.itemName</td>
                                @*<td>@string.Format("{0:G29}", Double.Parse(stitem.quantity.ToString())) @stitem.unitName</td>
                                <td>@string.Format("{0:G29}", Double.Parse(stitem.remain_quantity.ToString())) @stitem.unitName</td>*@
                                <td class="text-center">@string.Format("{0:G29}", Double.Parse(item.out_quantity.ToString())) @item.unitName</td>
                                <td>
                                    <label><input type="radio" class="approval" name="@name" value="approved"> Approve</label>

                                </td>
                                <td>
                                    <label><input type="radio" class="approval" name="@name" value="feedbacked"> Feedback</label>
                                </td>
                                <td>
                                    <textarea class="form-control feedback_comment">@item.remark</textarea>
                                </td>
                            </tr>

                                        }

                                        count++;


                                        @*foreach (var stitem in Model.itemTransfers)
                                        {
                                            if (item.product_id == stitem.st_item_id)
                                            {

                                                if (string.Compare(item.item_status, "completed") == 0)
                                                {
                                    <tr>
                                        <td>@count</td>
                                        <td>@item.itemCode</td>
                                        <td>@item.itemName</td>
                                        <td>@string.Format("{0:G29}", Double.Parse(stitem.quantity.ToString())) @stitem.unitName</td>
                                        <td>@string.Format("{0:G29}", Double.Parse(stitem.remain_quantity.ToString())) @stitem.unitName</td>
                                        <td>@string.Format("{0:G29}", Double.Parse(item.out_quantity.ToString())) @item.unitName</td>
                                        <td></td>
                                        <td></td>
                                        <td>@item.remark</td>
                                    </tr>
                                }
                                else
                                {
                                    string name = "item" + cc;
                                    <tr>
                                        <td>@count</td>
                                        <td>
                                            @{
                                                name = "item" + cc;
                                                <input type="hidden" value="@item.inventory_id" class="transfer_detail" />
                                                cc++;
                                            }
                                            
                                            @item.itemCode
                                        </td>
                                        <td>@item.itemName</td>
                                        <td>@string.Format("{0:G29}", Double.Parse(stitem.quantity.ToString())) @stitem.unitName</td>
                                        <td>@string.Format("{0:G29}", Double.Parse(stitem.remain_quantity.ToString())) @stitem.unitName</td>
                                        <td>@string.Format("{0:G29}", Double.Parse(item.out_quantity.ToString())) @item.unitName</td>
                                        <td>
                                            <label><input type="radio" class="approval" name="@name" value="approved"> Approve</label>

                                        </td>
                                        <td>
                                            <label><input type="radio" class="approval" name="@name" value="feedbacked"> Feedback</label>
                                        </td>
                                        <td>
                                            <textarea class="form-control feedback_comment">@item.remark</textarea>
                                        </td>
                                    </tr>

                                }

                                count++;
                            }

                        }*@
                    }
                }
            </tbody>
        </table>
    </div>
    <div class="form-group">
        <div class="col-md-offset-2 col-md-10">
            <input type="button" value="Submit" class="btn btn-success" id="btnSubmit" onclick="approveFeedbackTransferFromMainStock()" />
            <a href="javascript:history.back()" class="btn btn-danger">Back</a>
        </div>
    </div>
</div>

@section scripts{
    <script type="text/javascript">

    $(function () {
        $('input:radio[name="app_header"]').change(
            function () {
                if ($(this).is(':checked') && $(this).val() == 'approved') {
                    // append goes here
                    //var inventoryDetailsId = $('.adjustment_detail_id');
                    var countTableRow = $('#returnTable tbody tr').length;
                    for (var i = 1; i <= countTableRow; i++) {
                        $("input[name=item" + i + "][value='approved']").prop("checked", true);
                    }
                } else {
                    //var inventoryDetailsId = $('.adjustment_detail_id');
                    var countTableRow = $('#returnTable tbody tr').length;
                    for (var i = 1; i <= countTableRow; i++) {
                        $("input[name=item" + i + "][value='feedbacked']").prop("checked", true);
                    }
                }
            });
    });
        function enable_submit_button(is_submit) {
            if (is_submit) {
                $('#btnSubmit').text("Submitting...");
                $('#btnSubmit').attr('disabled', true);
            } else {
                $('#btnSubmit').text("Submit");
                $('#btnSubmit').attr('disabled', false);
            }
        }
        function approveFeedbackTransferFromMainStock() {
            enable_submit_button(true);
        var models = [];
        var item_element = {};
        var countInvalidStatus = 0;
        var transferFromMainStockId = $('#return_main_stock_id').val();
        var transferDetails = $('.transfer_detail');
        var feedbackComments = $('.feedback_comment');
        for (var i = 1; i <= transferDetails.length; i++) {
            var item_status = $('input[name=item' + i + ']:checked').val();
            if (!item_status) countInvalidStatus++;
            var idx = Number(i - 1);
            item_element = {};
            item_element.inventory_id = transferDetails[idx].value;
            item_element.item_status = item_status;
            item_element.remark = feedbackComments[idx].value;
            models.push(item_element);
        }
        if (countInvalidStatus > 0) {
            alert("Please select Approve or Feedback option for each item.");
            return;
        }
        $.ajax({
            url: "@Url.Action("ApproveFeedback", "ReturnMainStock")",
            type: "post",
            dataType: "json",
            async: false,
            data: { id: transferFromMainStockId, models: models },
            success: function (da) {
                if (da.result == "success") {
                    alert('Your data has been sumitted successfully.');
                    window.location.href = '@Url.Action("Index")';
                } else {
                    alert('Your data is error while sumiting.');
                }
            },
            error: function (err) {
                alert('Your data is error while sumiting.');
            }
        });
    }
    </script>
    }

