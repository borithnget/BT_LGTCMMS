@model BT_KimMex.Models.WorkorderReturnedViewModel
@using Microsoft.AspNet.Identity;
@using BT_KimMex.Class;
@{
    ViewBag.Title = "Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string userid = User.Identity.GetUserId();
}

<h3 class="title">View Work Order Return Detail</h3>

<div class="form-horizontal">
    <div class="form-group">
        <label class="col-md-2">Date:</label>
        <label class="col-md-10">@CommonClass.ToLocalTime(Convert.ToDateTime(Model.created_date)).ToString("dd/MM/yyyy")</label>
    </div>
    <div class="form-group">
        <label class="col-md-2">Work Order Returned No.:</label>
        <label class="col-md-10">@Model.workorder_returned_number</label>
    </div>
    <div class="form-group">
        <label class="col-md-2">Work Order Issued Ref. <strong class="text-danger">*</strong>:</label>
        <label class="col-md-10">@Model.workorder_issued_number</label>
    </div>
    <div class="form-group">
        <label class="col-md-2">Project:</label>
        <label class="col-md-10" id="project_name">@Model.project_fullname</label>
    </div>
    <div class="form-group">
        <label class="col-md-2">Warehouse:</label>
        <label class="col-md-10" id="warehouse_name">@Model.warehouse_name</label>
        <input type="hidden" id="warehouse_id" />
    </div>
    <div class="row" style="margin:0 !important;">
        <table class="table table-bordered table-responsive" id="issueReturnTable">
            <thead>
                <tr>
                    <th>No.</th>
                    <th>Item Code</th>
                    <th>Item Name</th>
                    <th>Issued Qty</th>
                    <th>Return Qty</th>
                    <th>Unit</th>
                    <th>Invoice No.</th>
                    <th>Invoice Date</th>
                    <th>Remark</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @{
                    int count = 1;
                    foreach (var item in Model.inventoryDetails)
                    {
                        decimal total_issued_qty = Convert.ToDecimal(BT_KimMex.Class.WorkOrderIssue.GetWorkOrderIssueItembyItemId(Model.workorder_issued_id, item.inventory_item_id).Sum(s => s.issue_qty));
                        <tr>
                            <td>@count</td>
                            <td>@item.itemCode</td>
                            <td>@item.itemName</td>
                            @*<td>@Model.issueItems.Where(s=>string.Compare(s.product_id,item.inventory_item_id)==0).FirstOrDefault().out_quantity</td>*@
                            <td>@string.Format("{0:G29}", decimal.Parse(total_issued_qty.ToString()))</td>
                            <td>@item.quantity</td>
                            <td>@item.unitName</td>
                            <td>@item.invoice_number</td>
                            <td>@Convert.ToDateTime(item.invoice_date).ToString("dd/MM/yyyy")</td>
                            <td>@item.remark</td>
                            <td>@item.item_status</td>
                        </tr>
                        count++;
                    }
                }
            </tbody>
        </table>
    </div>


    <div class="form-group">
        <div class="col-md-offset-2 col-md-10">
            @if ((User.IsInRole(Role.SystemAdmin) || string.Compare(Model.created_by, userid) == 0))
            {
                if (string.Compare(Model.workorder_returned_status, Status.Pending) == 0)
                {
                    <button class="w3-button w3-tiny w3-deep-orange" id="btn-cancel">Request Cancel</button>
                }
            }
            @if ((User.IsInRole(Role.SystemAdmin) || User.IsInRole(Role.QAQCOfficer)) && (string.Compare(Model.workorder_returned_status, Status.Pending) == 0 || string.Compare(Model.workorder_returned_status, Status.Feedbacked) == 0))
            {
                <a href="@Url.Action("ApproveFeedback","WorkOrderReturned",new { id = Model.workorder_returned_id })" class="w3-button w3-tiny w3-teal">Approve/ Feedback</a>
            }

            @if ((User.IsInRole(Role.SystemAdmin) || User.IsInRole(Role.SiteStockKeeper)) && string.Compare(Model.workorder_returned_status, Status.Approved) == 0)
            {
                <a href="javascript:void(0)" class="w3-button w3-tiny w3-teal" id="btn-approve">Approve</a>
                <a href="javascript:void(0)" class="w3-button w3-tiny w3-deep-orange" id="btn-reject">Reject</a>
            }
            @if ((User.IsInRole(Role.SystemAdmin) || User.IsInRole(Role.SiteManager)) && string.Compare(Model.workorder_returned_status, Status.Checked) == 0)
            {
                <a href="javascript:void(0)" class="w3-button w3-tiny w3-teal" id="btn-check-approve">Approve</a>
                <a href="javascript:void(0)" class="w3-button w3-tiny w3-deep-orange" id="btn-check-reject">Reject</a>
            }

            <a href="javascript:history.back()" class="w3-button w3-tiny w3-red">Back</a>

        </div>
    </div>
</div>

@section scripts{
    @*<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js" type="text/javascript"></script>*@
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
    <script type="text/javascript">
        $(function () {

            $('#btn-cancel').click(function (e) {
                e.preventDefault();
                swal({
                    title: "Cancellation",
                    text: "Please input your cancel comment:",
                    icon: "warning",
                    content: "input",
                })
                .then((value) => {
                    $.ajax({
                        url: "/WorkOrderReturned/CancelRequest",
                        data: {
                            'id': '@Model.workorder_returned_id',
                            'comment': value,
                        },
                        type: 'GET',
                        success: function (da) {
                            swal("Request has been cancelled successfully.", {
                                icon: "success",
                            });
                            window.location.href = '@Url.Action("Index", "WorkOrderReturned")';
                        },
                        error: function (err) {
                            swal("Poof! " + err, {
                                icon: "error",
                            });
                        }
                    });
                });
            });

            $("#btn-approve").click(function (e) {
                e.preventDefault();
                swal({
                    title: "Confirmation",
                    text: "Do you want to approve this request?",
                    icon: "warning",
                    buttons: true,
                    //dangerMode: true,
                })
                .then((willDelete) => {
                    if (willDelete) {
                        $.ajax({
                            url: "/WorkOrderReturned/Approval",
                            data: {
                                'id': '@Model.workorder_returned_id',
                                'status': 'approved',
                                'comment': '',
                            },
                            type: 'GET',
                            success: function (da) {
                                swal("Request has been approved successfully.", {
                                    icon: "success",
                                });
                                window.location.href = '@Url.Action("Index", "WorkOrderReturned")';
                            },
                            error: function (err) {
                                swal("Poof! " + err, {
                                    icon: "error",
                                });
                            }
                        });



                    } else {
                        //swal("Your imaginary file is safe!");
                    }
                });
            });

            $("#btn-check-approve").click(function (e) {
                e.preventDefault();
                swal({
                    title: "Confirmation",
                    text: "Do you want to approve this request?",
                    icon: "warning",
                    buttons: true,
                    //dangerMode: true,
                })
                .then((willDelete) => {
                    if (willDelete) {
                        $.ajax({
                            url: "/WorkOrderReturned/Completed",
                            data: {
                                'id': '@Model.workorder_returned_id',
                                'status': 'approved',
                                'comment': '',
                            },
                            type: 'GET',
                            success: function (da) {
                                swal("Request has been approved successfully.", {
                                    icon: "success",
                                });
                                window.location.href = '@Url.Action("Index", "WorkOrderReturned")';
                            },
                            error: function (err) {
                                swal("Poof! " + err, {
                                    icon: "error",
                                });
                            }
                        });



                    } else {
                        //swal("Your imaginary file is safe!");
                    }
                });
            });

            $('#btn-reject').click(function (e) {
                e.preventDefault();
                swal({
                    title: "Rejection",
                    text: "Please input your reject comment:",
                    icon: "warning",
                    content: "input",
                })
                .then((value) => {
                    $.ajax({
                        url: "/WorkOrderReturned/Approval",
                        data: {
                            'id': '@Model.workorder_returned_id',
                            'status': 'rejected',
                            'comment': value,
                        },
                        type: 'GET',
                        success: function (da) {
                            swal("Request has been rejected successfully.", {
                                icon: "success",
                            });
                            window.location.href = '@Url.Action("Index", "WorkOrderReturned")';
                        },
                        error: function (err) {
                            swal("Poof! " + err, {
                                icon: "error",
                            });
                        }
                    });
                });
            });

            $('#btn-check-reject').click(function (e) {
                e.preventDefault();
                swal({
                    title: "Rejection",
                    text: "Please input your reject comment:",
                    icon: "warning",
                    content: "input",
                })
                .then((value) => {
                    $.ajax({
                        url: "/WorkOrderReturned/Completed",
                        data: {
                            'id': '@Model.workorder_returned_id',
                            'status': 'rejected',
                            'comment': value,
                        },
                        type: 'GET',
                        success: function (da) {
                            swal("Request has been rejected successfully.", {
                                icon: "success",
                            });
                            window.location.href = '@Url.Action("Index", "WorkOrderReturned")';
                        },
                        error: function (err) {
                            swal("Poof! " + err, {
                                icon: "error",
                            });
                        }
                    });
                });
            });

        });
    </script>
}