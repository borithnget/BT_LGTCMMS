@model BT_KimMex.Models.PurchaseOrderViewModel
@using BT_KimMex.Class
@{
    ViewBag.Title = "Edit";
    bool isPur;
    if (!User.IsInRole("Purchaser"))
    {
        isPur = false;
    }
    else
    {
        isPur = true;
    }
}
@*<link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/themes/base/jquery-ui.css" rel="stylesheet" type="text/css" />*@
<style type="text/css">
    #po_table thead th {
        text-align: center !important;
        vertical-align: middle !important;
    }
    #po_table tr td{
        vertical-align:middle !important;
    }
    #po_table tr td:nth-child(3) {
        text-align: left !important;
    }
    #po_table tr td:nth-child(4) {
        text-align: center !important;
    }
</style>
@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <div class="form-horizontal">
        <h3 class="title">Edit Purchase Order</h3>
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
        @Html.HiddenFor(model => model.purchase_order_id)
        @Html.HiddenFor(model => model.purchase_order_status)

        <div class="form-group">
            @Html.Label("PO Date :", htmlAttributes: new { @class = "control-label col-md-2" })
            @Html.Label("Date", new { @class = "col-md-10", id = "current_date" })
        </div>

        <div class="form-group">
            @Html.LabelFor(model => model.purchase_oder_number, htmlAttributes: new { @class = "control-label col-md-2" })
            @Html.Label(" ", new { @class = "col-md-10", id = "purchase_oder_number" })
        </div>
        <div class="form-group">
            @Html.LabelFor(model => model.ir_project_id, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
               @Html.DropDownList("ir_project_id",new SelectList(ViewBag.Projects, "project_id","project_full_name", Model.ir_project_id), new { @class = "form-control" })
            </div>
            @*@Html.Label(" ", new { @class = "col-md-10", id = "ir_project_id" })*@
        </div>
        <!--Rathana add 10.04.2019-->
        <div class="form-group">
            @Html.LabelFor(model => model.POLNumber, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                <label id="POLNumber" class="col-md-10" style="padding: 0;">@Model.POLNumber</label>
            </div>
        </div>
        <!--End Rathana Add-->
        <div class="form-group">
            <label class="control-label col-md-2">PR Ref.<strong style="color:red;">*</strong> :</label>
            <div class="col-md-10">
                @Html.DropDownList("item_request_id",new SelectList(ViewBag.IRID, "ir_id", "ir_no", Model.item_request_id), new { @class = "form-control", id = "item_request_id" })
                @Html.ValidationMessageFor(model => model.item_request_id, "", new { @class = "text-danger" })
            </div>
        </div>
        <!--Rathana add 10.04.2019-->
        <div class="form-group">
            @Html.LabelFor(model => model.ShippingTo, htmlAttributes: new { @class = "control-label col-md-2" })
            @*@Html.Label(" ", new { @class = "col-md-10", id = "ir_project_id" })*@
            <div class="col-md-10">
                @Html.HiddenFor(m => m.ShippingTo)
                @Html.TextBox("ShippingUser", CommonClass.ConvertUserDetailIDToName(Model.ShippingTo), null, new { @class = "form-control" })
            </div>

        </div>
        <!--End Rathana Add-->
        
        <div class="row" style="margin:0 !important;">
            <table class="table table-responsive table-bordered" id="po_table">
                <thead>
                    <tr>
                        <th rowspan="2">No.</th>
                        <th rowspan="2">Item Code</th>
                        <th rowspan="2">Item Name</th>
                        <th rowspan="2">Unit</th>
                        <th rowspan="2">QTY</th>
                        <th colspan="2">Supplier 1</th>
                        <th colspan="2">Supplier 2</th>
                        <th colspan="2">Supplier 3</th>
                        <th rowspan="2"></th>
                        <th rowspan="2"></th>
                    </tr>
                    <tr>
                        <th>Name</th>
                        <th>Unit Price</th>
                        <th>Name</th>
                        <th>Unit Price</th>
                        <th>Name</th>
                        <th>Unit Price</th>
                    </tr>
                </thead>
                <tbody>

                    @*@{
                            int count = 1;
                            foreach (var item in Model.poDetails)
                            {
                                var row_id = "item" + count;
                                <tr id="@row_id">
                                    <td>@count</td>
                                    <td><input type='hidden' class='item_id' value='@item.item_id' /><label class='item_code'>@item.product_code</label></td>
                                    <td><label class='item_name'>@item.product_name</label></td>
                                    <td><label class='item_unit'>@item.product_unit</label></td>
                                    <td><input type='number' class='form-control po_item_qty' value='@item.quantity' /></td>
                                    @{
                                        var sups = item.poSuppliers;
                                        for (int i = 0; i < 3; i++)
                                        {
                                            var sup_name = "sup" + (i + 1) + "_name";
                                            var sup_price = "sup" + (i + 1) + "_unit_price";
                                            if (i < sups.Count())
                                            {
                                    <td>@Html.DropDownList(sup_name, new SelectList(@ViewBag.SupplierID, "supplier_id", "supplier_name", sups[i].supplier_id), new { @class = "form-control " + sup_name })</td>
                                    <td><input type='number' class='form-control @sup_price' value='@sups[i].unit_price' /></td>
                                            }
                                            else
                                            {
                                    <td>@Html.DropDownList(sup_name, new SelectList(@ViewBag.SupplierID, "supplier_id", "supplier_name"), "Select Supplier", new { @class = "form-control " + sup_name })</td>
                                    <td><input type='number' class='form-control @sup_price' value='0.00' /></td>
                                            }
                                        }
                                    <td><a href='javascript:void(0)' class='btn btn-default' onclick='remove_po_row(this,false)'><span class='glyphicon glyphicon-remove-sign'></span></a></td>
                                    <td>
                                        @{
                                            if (count == (Model.poDetails).Count())
                                            {
                                                <a href='javascript:void(0)' class='btn btn-default' onclick='append_po_row(this,false)'><span class='glyphicon glyphicon-plus-sign'></span></a>
                                            }
                                        }
                                    </td>
                                            }

                                </tr>
                                                count++;
                                            }
                        }*@
                </tbody>
            </table>
        </div>
        <div class="form-group">
            <label class="col-md-2 control-label">Attachment Reference :</label>
            <div class="col-md-10" id="attachment_block">
                @{
                    var atts = Model.poAttachments;

                    if (atts.Count() == 0)
                    {
                        <input type="file" class="form-control" name="attachment_reference" id="attachment_reference" />
                    }
                    else
                    {
                        <table id="tableAttachment">
                            @for (int i = 0; i < atts.Count(); i++)
                            {
                                <tr>
                                    <td><a class="title @i" href="/PurchaseOrder/Download/?p=@(atts[i].po_attachment_id + atts[i].po_attachment_extension)&d=@atts[i].po_attachment_name">@atts[i].po_attachment_name</a></td>
                                    <td><a href="javascript:void(0);" class="btn btn-default delete-att title @i" data-id="@atts[i].po_attachment_id">X</a></td>
                                    @{ if (i == atts.Count() - 1)
                                        {
                                            <td><a href="javascript:void(0);" class="btn btn-default add-row " data-id="@atts[i].po_attachment_id">+</a></td>
                                        }
                                    }
                                </tr>
                                        }
                        </table>

                                        }
                }

            </div>
        </div>
        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <input type="button" id="btnSave" value="Submit" class="btn btn-default" />
                <a href="@Url.Action("Index")" class="btn btn-default">Back</a>
            </div>
        </div>
    </div>
                                        }
@section Scripts{
    @*<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/jquery-ui.min.js"></script>*@
    <script type="text/javascript">
        $(function () {
            var arrDeletedAttachment = [];
            $('#current_date').text(getFormattedDateMMDDYYYY(new Date('@Model.created_date')));
            $('#purchase_oder_number').text('@Model.purchase_oder_number');
            @*$("#ir_project_id").text('@Model.project_full_name');*@
            $('#item_request_id').change(function () {
                var irID = $(this).val();
                //GetProjectName(irID);
                GetItemRequestData(irID, false, '@Model.purchase_order_id');
            });

            $('#ir_project_id').on('change', function (e) {
                e.preventDefault();
                var projectId = $(this).val();
                $('#item_request_id').empty().append("<option>Select Purchase Requisition</option>");;
                $('#po_table tbody').empty();
                if (projectId) {
                    $.ajax({
                        url: '@Url.Action("GetItemRequestsbyProject", "PurchaseOrder")',
                        type: "get",
                        dataType: "json",
                        data: { id: projectId },
                        success: function (da) {
                            //console.log(da);
                            $.each(da, function (index, item) {
                                $('#item_request_id').append("<option value='" + item.ir_id + "'>" + item.ir_no + "</option>");
                            });
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            console.log(XMLHttpRequest);
                        }
                    });
                }

            });

            initialPurchaseOrder('@Model.purchase_order_id');

            $('.delete-att').click(function (e) {
                e.preventDefault();
                var att_id = $(this).data('id');
                arrDeletedAttachment.push(att_id);
                var index = $(this)[0].parentNode.parentNode.rowIndex;
                document.getElementById('tableAttachment').deleteRow(index);
                var rowCount = $('#tableAttachment tr').length;
                if (rowCount == 0) {
                    $("#attachment_block").empty();
                    $("#attachment_block").append("" +
                        '<input type="file" class="form-control" name="attachment_reference" id="attachment_reference" multiple />'
                        );
                }
            });

            $('.add-row').click(function (e) {
                e.preventDefault();
                $('#tableAttachment').append("" +
                   "<tr>" +
                        '<td><input type="file" class="form-control" name="attachment_reference" id="attachment_reference" multiple /></td>' +
                        '<td><a href="javascript:void(0);" class="btn btn-default delete-att" onclick="removeAttachmentRow(this)">X</a></td>' +
                   "</tr>"
                 );
                $(this).remove();
            });
            function enable_submit_button(is_submit) {
                if (is_submit) {
                    $('#btnSave').text("Submitting...");
                    $('#btnSave').attr('disabled', true);
                } else {
                    $('#btnSave').text("Submit");
                    $('#btnSave').attr('disabled', false);
                }
            }
            $('#btnSave').click(function () {
                enable_submit_button(true);
                var ir_id = $('#item_request_id').val();
                var po_number = $('#purchase_oder_number').text();
                var po_id = $('#purchase_order_id').val();
                var purchase_order_status = $('#purchase_order_status').val();
                var items = $('.item_id');
                var item_units = $('.item_unit');
                //var po_qtys = $('.po_item_qty');
                var po_qtys = $('.approved_qty');
                var supplier1_name = $('.sup1_name');
                var supplier2_name = $('.sup2_name');
                var supplier3_name = $('.sup3_name');
                var supplier1_price = $('.sup1_unit_price');
                var supplier2_price = $('.sup2_unit_price');
                var supplier3_price = $('.sup3_unit_price');
                var select_vat = $('.select_vat');
                var selected_supplier = $('.selected_supplier');
                var item_element = {};
                var pDetails = [];
                var supplier1_element = {};
                var poSupplier1 = [];
                var supplier2_element = {};
                var poSupplier2 = [];
                var supplier3_element = {};
                var poSupplier3 = [];
                var arrAttachment = [];
                var countSupplier = 0;
                //Rathana Add 10.04.2019
                var PolNumber = $('#POLNumber').text();
                var ShippingTo = $('#ShippingTo').val();
                if ($('#ShippingUser').val() == "" ) {
                    ShippingTo = "";
                }
                //End Rathana Add
                var arrSup = [];
                if (!ir_id) {
                    alert("Item Request Reference is required.");
                    return;
                }
                if (items.length == 0) {
                    alert("Item is required.");
                    return;
                }

                if (arrDeletedAttachment.length > 0) {
                    for (var i = 0; i < arrDeletedAttachment.length; i++) {
                        var attID = arrDeletedAttachment[i];
                        $.ajax({
                            url: '@Url.Action("DeleteAttachment", "PurchaseOrder")',
                            type: 'POST',
                            data: { id: attID }
                        }).done(function (data) {
                            if (data.Result == "ok") {

                            }
                            else if (data.Result.Message) {
                                alert(data.Result.Message);
                            }
                        }).fail(function () {
                            //alert("There is something wrong. Please try again.");
                        })
                    }
                }

                var form_data = new FormData();
                var file_input = document.getElementById('attachment_reference');
                if (file_input != undefined) {
                    if (file_input.files.length > 0) {
                        for (var i = 0; i < file_input.files.length; i++) {
                            form_data = new FormData();
                            form_data.append(file_input.files[i].name, file_input.files[i]);
                            $.ajax({
                                url: '@Url.Action("UploadAttachment","PurchaseOrder")',
                                type: "POST",
                                data: form_data,
                                async: false,
                                cache: false,
                                contentType: false,
                                processData: false,
                                success: function (da) {
                                    if (da.result == "success")
                                        arrAttachment.push(da.attachment_id);
                                },
                                error: function (xhr, error, status) {
                                    console.log(error, status);
                                }
                            });
                        }
                    }
                }

                for (var i = 0; i < items.length; i++) {
                    item_element = {};
                    item_element.po_detail_id = (i + 1);
                    item_element.item_id = items[i].value;
                    item_element.item_unit = item_units[i].innerHTML;
                    item_element.quantity = po_qtys[i].innerHTML;
                    arrSup = [];

                    $('.selected_supplier:checkbox').each(function () {
                        countSupplier++;
                        var supNumber = $(this).val();
                        arrSup.push(supNumber);
                    });

                    var po_supplier = {};
                    var poSuppliers = [];
                    var c = 1;
                    for (var j = 0; j < arrSup.length; j++) {
                        var n = arrSup[j];
                        n = n.substr(0, n.length - 1);
                        if (Number(n) == Number(item_element.po_detail_id)) {
                            var supselect = $('#sselect' + arrSup[j]).is(':checked');
                            var supname = $('#sname' + arrSup[j]).val();
                            var supprice = $('#sprice' + arrSup[j]).text();
                            var isChecked = $('#svat' + arrSup[j]).is(':checked');
                            po_supplier = {};
                            po_supplier.po_detail_id = item_element.po_detail_id;
                            po_supplier.po_detail_id = item_element.po_detail_id;
                            po_supplier.supplier_id = supname;
                            po_supplier.unit_price = supprice;
                            item_element.item_vat = "0";
                            po_supplier.vat = isChecked;
                            po_supplier.is_check = supselect;
                            po_supplier.sup_number = c;
                            poSuppliers.push(po_supplier);
                            c++;
                        }
                    }
                    item_element.poSuppliers = poSuppliers;
                    pDetails.push(item_element);

                }
                var model = {
                    purchase_order_id: po_id,
                    purchase_oder_number: po_number,
                    purchase_order_status: purchase_order_status,
                    item_request_id: ir_id,
                    POLNumber: PolNumber,
                    ShippingTo: ShippingTo
                }

                $.ajax({
                    url: "@Url.Action("EditPurchaseOrder", "PurchaseOrder")",
                    type: "post",
                    dataType: "json",
                    async: false,
                    data: { model: model, pDetails: pDetails, supplier1: poSupplier1, supplier2: poSupplier2, supplier3: poSupplier3, Attachment: arrAttachment },
                    success: function (da) {
                        if (da.result == "success") {
                            $.notify('Your data has been updated!', { className: 'success' });
                            window.location.href = '@Url.Action("Index","PurchaseOrder")';
                        } else {
                            console.log(da.message);
                            $.notify(da.message, { className: 'error' });
                        }
                    },
                    error: function (err) {
                        $.notify('Your data is error while updating!', { className: 'error' });
                    }
                });
            });
        });
    </script>
    <script type="text/javascript">
        function GetProjectName(irID) {
            if (irID) {
                $.ajax({
                    url: '@Url.Action("GetProjectNameByIRID", "PurchaseOrder")',
                    type: "get",
                    dataType: "json",
                    data: { id: irID },
                    success: function (da) {
                        if (da.result == "success") {
                            $('#ir_project_id').text(da.data);
                        } else {
                            $('#ir_project_id').text(' ');
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        $('#ir_project_id').text(' ');
                    }
                });
            }
            else {
                $('#ir_project_id').text(' ');
            }
        }

        function InitialSupplierDropdownlist(isBtn) {
            $.ajax({
                url: '@Url.Action("GetSupplierDropdownList", "PurchaseOrder")',
                type: "get",
                dataType: "json",
                success: function (da) {
                    if (da.data) {

                        if (isBtn) {
                            $('#po_table tr:last-child').find('select.sup1_name').empty();
                            $('#po_table tr:last-child').find('select.sup2_name').empty();
                            $('#po_table tr:last-child').find('select.sup3_name').empty();
                            $('#po_table tr:last-child').find('select.sup1_name').append("<option value=''>Select supplier</option>");
                            $('#po_table tr:last-child').find('select.sup2_name').append("<option value=''>Select supplier</option>");
                            $('#po_table tr:last-child').find('select.sup3_name').append("<option value=''>Select supplier</option>");
                            $.each(da.data, function (index, item) {
                                $('#po_table tr:last-child').find('select.sup1_name').append("<option value='" + item.supplier_id + "'>" + item.supplier_name + "</option>");
                                $('#po_table tr:last-child').find('select.sup2_name').append("<option value='" + item.supplier_id + "'>" + item.supplier_name + "</option>");
                                $('#po_table tr:last-child').find('select.sup3_name').append("<option value='" + item.supplier_id + "'>" + item.supplier_name + "</option>");
                            });
                        } else {
                            $('#po_table select.sup1_name').empty();
                            $('#po_table select.sup2_name').empty();
                            $('#po_table select.sup3_name').empty();
                            $('#po_table select.sup1_name').append("<option value=''>Select supplier</option>");
                            $('#po_table select.sup2_name').append("<option value=''>Select supplier</option>");
                            $('#po_table select.sup3_name').append("<option value=''>Select supplier</option>");
                            $.each(da.data, function (index, item) {
                                $('#po_table select.sup1_name').append("<option value='" + item.supplier_id + "'>" + item.supplier_name + "</option>");
                                $('#po_table select.sup2_name').append("<option value='" + item.supplier_id + "'>" + item.supplier_name + "</option>");
                                $('#po_table select.sup3_name').append("<option value='" + item.supplier_id + "'>" + item.supplier_name + "</option>");
                            });
                        }
                    } else {

                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {

                }
            });
        }
        function removeAttachmentRow(row) {
            var index = row.parentNode.parentNode.rowIndex;
            document.getElementById('tableAttachment').deleteRow(index);
            var rowCount = $('#tableAttachment tr').length;
            if (rowCount == 0) {
                $("#attachment_block").empty();
                $("#attachment_block").append("" +
                    '<input type="file" class="form-control" name="attachment_reference" id="attachment_reference" multiple />'
                    );
            }
        }

        function initialPurchaseOrder(id) {
            $.ajax({
                url: '@Url.Action("GetPurchaseOrderDetailJson", "PurchaseOrder")',
                type: "get",
                dataType: "json",
                data: { id: id },
                async: false,
                success: function (da) {
                    if (da.result == "success") {
                        var purchaseOrder = da.data;
                        if (purchaseOrder) {
                            var ir_id = purchaseOrder.item_request_id;
                            GetItemRequestData(ir_id, true, purchaseOrder.purchase_order_id);
                        }
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {

                }
            });
        }

        function GetItemRequestData(irID, isInitial, po_id) {
            if (irID) {
                $.ajax({
                    url: '@Url.Action("GetItemRequestJson", "PurchaseOrder")',
                    type: "get",
                    dataType: "json",
                    data: { id: irID, poId:po_id},
                    async: false,
                    success: function (da) {
                        if (da.result == "success") {
                            $('#po_table tbody').empty();
                            var maxSupplier = 0;
                            $.each(da.data, function (index, item) {

                                if (da.quotes) {
                                    var quotes = da.quotes;
                                    var count = 0;
                                    $.each(quotes, function (index1, item1) {
                                        if (item1.item_id == item.ir_item_id) {
                                            count++;
                                        }
                                    });

                                    if (maxSupplier < count)
                                        maxSupplier = count;
                                }
                            });

                            initialPOTable(maxSupplier, irID, isInitial, po_id);

                        } else {
                            $('#po_table tbody tr').empty();
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        $('#po_table tbody tr').empty();
                    }
                });
            } else {
                $('#po_table tbody tr').empty();
            }
        }

        function initialPOTable(num_supplier, ir_id, isInitial, po_id) {

            var firstRowSupplier = "";
            var secondRowSupplier = "";
            $('#po_table').empty();
            firstRowSupplier = "";
            secondRowSupplier = "";

            for (var i = 1; i <= num_supplier; i++) {
                firstRowSupplier = firstRowSupplier + "<th colspan='4'>Supplier " + i + "</th>";
                secondRowSupplier = secondRowSupplier + "<th></th><th>VAT</th><th>Name</th><th>Unit Price</th>";
            }
            $('#po_table').append("" +
                "<thead>" +
                    "<tr>" +
                        "<th rowspan='2'>No.</th>" +
                        "<th rowspan='2'>Item Code</th>" +
                        "<th rowspan='2'>Item Name</th>" +
                        "<th rowspan='2'>Requested QTY</th>" +
                        "<th rowspan='2'>Unit</th>" +
                        firstRowSupplier +
                        "<th rowspan='2'></th>" +
                    "</tr>" +
                "</thead>"
            );
            $('#po_table thead').append("" +
                    "<tr>" +
                        secondRowSupplier +
                    "</tr>"
            );
            initialPOData(num_supplier, ir_id, isInitial, po_id);

            function initialPOData(num_supplier, ir_id, isInitial, po_id) {
                var itemRequestSupplier;
                var poSupplier;
                
                $.ajax({
                    url: '@Url.Action("GetItemRequestJson", "PurchaseOrder")',
                    type: "get",
                    dataType: "json",
                    data: { id: ir_id, poId: po_id },
                    async: false,
                    success: function (da) {
                        if (da.result == "success") {
                            var maxSupplier = 0;
                            $.each(da.data, function (index, item) {
                                var suppliers = "";

                                if (da.quotes) {
                                    var quotes = da.quotes;
                                    var count = 0;
                                    itemRequestSupplier = quotes;
                                    if (!isInitial) {
                                        $.each(quotes, function (index1, item1) {
                                            if (item1.item_id == item.ir_item_id) {
                                                count++;
                                                var sup_name_cls = "sup" + Number(count) + "_name";
                                                var sup_vat_cls = "sup" + Number(count) + "_vat";
                                                var sup_price_cls = "sup" + Number(count) + "_unit_price";
                                                var sup_select_id = "sselect" + Number(index + 1) + count;
                                                var sup_name_id = "sname" + Number(index + 1) + count;
                                                var sup_vat = "svat" + Number(index + 1) + count;
                                                var sup_price_id = "sprice" + Number(index + 1) + count;
                                                var name = "itemvat" + Number(index + 1) + count;

                                                suppliers = suppliers +
                                                    "<td><input type='checkbox' id='" + sup_select_id + "' class='selected_supplier' value='" + Number(index + 1) + count + "'/></td>" +
                                                    "<td><input type='checkbox' id='" + sup_vat + "' class='" + sup_vat_cls + " select_vat' name='" + name + "' value='" + Number(index + 1) + count + "'/></td>" +
                                                    "<td><input type='hidden' id='" + sup_name_id + "' class='" + sup_name_cls + "' value='" + item1.supplier_id + "'/><label>" + item1.supplier_name + "</label></td>" +
                                                    "<td><label class='" + sup_price_cls + "' id='" + sup_price_id + "'>" + parseFloat(item1.price).toFixed(2) + "</label></td>";
                                                
                                                //suppliers = suppliers + "<td><input type='checkbox' /></td><td><input type='checkbox' class='selected_supplier' value='" + Number(index + 1) + count + "'/></td><td><input type='hidden' id='" + sup_name_id + "' class='" + sup_name_cls + "' value='" + item1.supplier_id + "'/><label>" + item1.supplier_name + "</label></td><td><label class='" + sup_price_cls + "' id='" + sup_price_id + "'>" + parseFloat(item1.price).toFixed(2) + "</label></td>";
                                            }
                                        });
                                        for (var i = 1; i <= Number(num_supplier - count) ; i++)
                                            suppliers = suppliers + "<td></td><td></td><td></td><td></td>";
                                        $('#po_table').append("" +
                                            "<tr id='item" + Number(index + 1) + "'>" +
                                                "<td>" + Number(index + 1) + "</td>" +
                                                "<td><input type='hidden' class='item_id' value='" + item.ir_item_id + "'/><label class='item_code'>" + item.product_code + "</label></td>" +
                                                "<td><label class='item_name'>" + item.product_name + "</label></td>" +
                                                "<td><label class='approved_qty' style='vertical-align:middle;'>" + item.remain_qty + "</label></td>" +
                                                "<td><label class='item_unit'>" + item.ir_item_unit + "</label></td>" +
                                                suppliers +
                                                "<td><a href='javascript:void(0)' class='btn btn-default btn-sm' onclick='remove_po_item(this)'><span class='glyphicon glyphicon-trash'></span></a></td>" +
                                            "</tr>"
                                        );
                                    }
                                }
                            });
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        $('#po_table tbody tr').empty();
                    }
                });

                if (isInitial) {

                    $.ajax({
                        url: '@Url.Action("GetPurchaseOrderDetailJson", "PurchaseOrder")',
                        type: "get",
                        dataType: "json",
                        data: { id: po_id },
                        async: false,
                        success: function (da) {
                            if (da.result == "success") {
                                var purchaseOrder = da.data;
                                if (purchaseOrder) {
                                    $.each(purchaseOrder.poDetails, function (index, item) {
                                        var count = 0;
                                        var suppliers = "";
                                        
                                        poSupplier = item.poSuppliers;
                                        
                                        if (itemRequestSupplier) { //itemRequestSupplier
                                            var ccount = 0;
                                            var check = false;
                                            var checkvat = false;
                                            $.each(itemRequestSupplier, function (index1, item1) {
                                                check = false;
                                                if (item1.item_id == item.item_id) {
                                                    //console.log(item1);
                                                    ccount++;
                                                    var sup_name_cls = "sup" + Number(ccount) + "_name";
                                                    var sup_price_cls = "sup" + Number(ccount) + "_unit_price";
                                                    var sup_select_id = "sselect" + Number(index + 1) + ccount;
                                                    var sup_name_id = "sname" + Number(index + 1) + ccount;
                                                    var sup_price_id = "sprice" + Number(index + 1) + ccount;
                                                    var sup_vat_cls = "sup" + Number(ccount) + "_vat";
                                                    var sup_vat = "svat" + Number(index + 1) + ccount;
                                                    var name = "itemvat" + Number(index + 1) + ccount;

                                                    $.each(item.poSuppliers, function (index2, item2) {
                                                        //console.log(item2);
                                                       
                                                        if (item1.supplier_id == item2.supplier_id) {
                                                            var selected_control;
                                                            //added oct 02 2018
                                                            if (item2.is_check)
                                                                selected_control = "<input type='checkbox' class='selected_supplier' id='" + sup_select_id + "' value='" + Number(index + 1) + ccount + "' checked/>";
                                                            else
                                                                selected_control = "<input type='checkbox' class='selected_supplier' id='" + sup_select_id + "' value='" + Number(index + 1) + ccount + "'/>";
                                                            if (item2.vat == true) {
                                                                suppliers = suppliers +
                                                                    "<td>" + selected_control + "</td>" +
                                                                    "<td><input type='checkbox' id='" + sup_vat + "' class='" + sup_vat_cls + " select_vat' name='" + name + "' value='" + Number(index + 1) + ccount + "' checked /></td>" +                                                                
                                                                    "<td><input type='hidden' id='" + sup_name_id + "' class='" + sup_name_cls + "' value='" + item1.supplier_id + "'/><label>" + item1.supplier_name + "</label></td>" +
                                                                    "<td><label class='" + sup_price_cls + "' id='" + sup_price_id + "'>" + parseFloat(item1.price).toFixed(2) + "</label></td>";
                                                                check = true;
                                                                return false;
                                                            }
                                                            suppliers = suppliers +
                                                                "<td>" + selected_control + "</td>" +
                                                                "<td><input type='checkbox' id='" + sup_vat + "' class='" + sup_vat_cls + " select_vat' name='" + name + "' value='" + Number(index + 1) + ccount + "' /></td>" +
                                                                "<td><input type='hidden' id='" + sup_name_id + "' class='" + sup_name_cls + "' value='" + item1.supplier_id + "'/><label>" + item1.supplier_name + "</label></td>" +
                                                                "<td><label class='" + sup_price_cls + "' id='" + sup_price_id + "'>" + parseFloat(item1.price).toFixed(2) + "</label></td>";
                                                            check = true;
                                                            return false;
                                                        }
                                                    });
                                                    if (!check)
                                                        suppliers = suppliers +
                                                            "<td><input type='checkbox' class='selected_supplier' value='" + Number(index + 1) + ccount + "' /></td>" +
                                                            "<td><input type='checkbox' id='" + sup_vat + "' class='" + sup_vat_cls + " select_vat' name='" + name + "' value='" + Number(index + 1) + count + "'/></td>" +
                                                            "<td><input type='hidden' id='" + sup_name_id + "' class='" + sup_name_cls + "' value='" + item1.supplier_id + "'/><label>" + item1.supplier_name + "</label></td>" +
                                                            "<td><label class='" + sup_price_cls + "' id='" + sup_price_id + "'>" + parseFloat(item1.price).toFixed(2) + "</label></td>";
                                                }
                                            });
                                            for (var i = 1; i <= Number(num_supplier - ccount) ; i++)
                                                suppliers = suppliers + "<td></td><td></td><td></td><td></td>";
                                        }

                                        $('#po_table').append("" +
                                                "<tr id='item" + Number(index + 1) + "'>" +
                                                    "<td>" + Number(index + 1) + "</td>" +
                                                    "<td><input type='hidden' class='item_id' value='" + item.item_id + "'/><label class='item_code'>" + item.product_code + "</label></td>" +
                                                    "<td><label class='item_name'>" + item.product_name + "</label></td>" +
                                                    "<td><label class='approved_qty' style='vertical-align:middle;'>" + item.quantity + "</label></td>" +
                                                    "<td><label class='item_unit'>" + item.item_unit + "</label></td>" +
                                                    suppliers +
                                                    "<td><a href='javascript:void(0)' class='btn btn-default btn-sm' onclick='remove_po_item(this)'><span class='glyphicon glyphicon-trash'></span></a></td>" +
                                                "</tr>"
                                            );
                                    });
                                }
                            }
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {

                        }
                    });
                    
                }
            }
        }

        function checkSupplier(id) {
            $.ajax({
                url: '@Url.Action("GetPurchaseOrderDetailJson", "PurchaseOrder")',
                type: "get",
                dataType: "json",
                data: { id: id },
                success: function (da) {
                    if (da.result == "success") {
                        var purchaseOrder = da.data;
                        if (purchaseOrder) {
                            var tableRow = $('#po_table tbody tr').length;
                            console.log(tableRow);
                            var selected_supplier = $('.selected_supplier');
                            if (selected_supplier.length > 0) {
                                $.each(purchaseOrder.poDetails, function (index, item) {
                                    $.each(item.poSuppliers, function (index1, item1) {
                                        console.log(item1);

                                    });
                                });
                            }
                        }
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {

                }
            });
        }
        function remove_po_item(row) {
            var ind = row.parentNode.parentNode.rowIndex;
            var item_cls = $('#po_table tr').eq(ind).attr('class');
            var item_id = $('#po_table tr').eq(ind).attr('id');
            var arr_item_id = new Array();
            var count_table_row = $('#po_table tr').length;

            for (var i = 1; i <= count_table_row; i++) {
                var id = $('#po_table tr').eq(i).attr('id');
                if (id != undefined && id.substr(0, 4) == "item")
                    arr_item_id.push(id);
            }
            document.getElementById('po_table').deleteRow(ind);

            var deletedIndex = ind - 1;
            var maxSupplier = 0;
            var supCheckboxes = $('input[type=checkbox].selected_supplier');
            var vatCheckboxes = $('input[type=checkbox].select_vat');
            for (var i = 0; i < supCheckboxes.length; i++) {
                var newCheckbox;
                var oldCheckbox = supCheckboxes[i].value;
                var firstDigit = oldCheckbox.substr(0, oldCheckbox.length - 1);
                var secondDigit = oldCheckbox.substr(oldCheckbox.length - 1, 1);
                if (Number(secondDigit) > Number(maxSupplier))
                    maxSupplier = secondDigit;
                if (firstDigit > deletedIndex) {
                    newCheckbox = (Number(firstDigit) - 1) + secondDigit;
                } else
                    newCheckbox = firstDigit + secondDigit;
                supCheckboxes[i].value = newCheckbox;
                supCheckboxes[i].id = "sselect" + newCheckbox;
                vatCheckboxes[i].value = newCheckbox;
                vatCheckboxes[i].id = "svat" + newCheckbox;
                vatCheckboxes[i].name = "itemvat" + newCheckbox;
                //console.log(newCheckbox);
            }

            for (var j = 1; j <= maxSupplier; j++) {
                var sup1Names = $('input[type=hidden].sup' + j + '_name');
                var supPrices = $('label.sup' + j + '_unit_price');
                for (var i = 0; i < sup1Names.length; i++) {
                    var newSupnameId, newSupPriceId;
                    var oldSupnameId = sup1Names[i].id.replace(/[^\d]/g, '');
                    var firstDigit = oldSupnameId.substr(0, oldSupnameId.length - 1);
                    var secondDigit = oldSupnameId.substr(oldSupnameId.length - 1, 1);
                    if (firstDigit > deletedIndex) {
                        newSupnameId = (Number(firstDigit) - 1) + secondDigit;
                    } else
                        newSupnameId = firstDigit + secondDigit;
                    newSupPriceId = "sprice" + newSupnameId;
                    newSupnameId = "sname" + newSupnameId;
                    sup1Names[i].id = newSupnameId;
                    supPrices[i].id = newSupPriceId;
                    //console.log(newSupnameId);
                }
            }

            if (arr_item_id.length > 1) {
                var deleted_index = arr_item_id.indexOf(item_id);
                arr_item_id.splice(deleted_index, 1);
                for (var i = 0; i < arr_item_id.length; i++)
                    $('tr#' + arr_item_id[i]).find('td:first-child').html(Number(i + 1));
            }


        }
        /*
        function remove_po_item(row) {
            var ind = row.parentNode.parentNode.rowIndex;
            var item_cls = $('#po_table tr').eq(ind).attr('class');
            var item_id = $('#po_table tr').eq(ind).attr('id');
            var arr_item_id = new Array();
            var count_table_row = $('#po_table tr').length;

            for (var i = 1; i <= count_table_row; i++) {
                var id = $('#po_table tr').eq(i).attr('id');
                if (id != undefined && id.substr(0, 4) == "item")
                    arr_item_id.push(id);
            }
            document.getElementById('po_table').deleteRow(ind);
            if (arr_item_id.length > 1) {
                var deleted_index = arr_item_id.indexOf(item_id);
                arr_item_id.splice(deleted_index, 1);
                for (var i = 0; i < arr_item_id.length; i++)
                    $('tr#' + arr_item_id[i]).find('td:first-child').html(Number(i + 1));
            }
        }
        */
    </script>


    <!-- Rathana Script -->
<script type="text/javascript">

        $("#ir_project_id").change(function () {
            if (this.value != "") {
                GetPOLNumberProduct(this.value, function (data) {
                    var pol = '@Model.purchase_oder_number';
                    var splitPol = pol.split('-');
                    $('#POLNumber').html(splitPol[0] + "-" + data + "-" + splitPol[1] + "-" + splitPol[2] + "-" + splitPol[3]);
                })
            }
            else {
                $('#POLNumber').html('');
            }
        });

        function GetPOLNumberProduct(id, callback) {
            $.ajax({
                url: "/PurchaseOrder/GetProjectShortNameByProjectID",
                type: "post",
                data: { id: id },
                success: function (respone) {
                    console.log(respone.ProShortName)
                    if (respone.success) {
                        callback(respone.ProShortName);
                    }
                }
            });
        }

        $("#ShippingUser").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "/PurchaseOrder/GetUserDetailAutocomplete",
                    dataType: "json",
                    type: "post",
                    data: {
                        term: request.term
                    },
                    success: function (data) {
                        response(data);
                    }
                });
            },
            select: function (event, ui) {
                var selectedObj = ui.item;
                $("#ShippingUser").val(selectedObj.label);
                $('#ShippingTo').val(selectedObj.value);
                return false;
            }
        });

</script>
}

